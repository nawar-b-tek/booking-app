<ion-content class="annonce-detail-page" *ngIf="annonce as a; else loadingTpl">
  <!-- Photo Gallery -->
  <div class="photo-gallery" *ngIf="a.photos && a.photos.length > 0">
    <div class="main-photo">
      <img [src]="a.photos[0]" alt="Photo principale" />
      <div class="photo-badge" *ngIf="a.isBooked">
        <ion-icon name="checkmark-circle"></ion-icon>
        Réservé
      </div>
    </div>
    <div class="photo-thumbnails" *ngIf="a.photos.length > 1">
      <img *ngFor="let photo of a.photos.slice(1, 5)" [src]="photo" alt="Photo" />
      <div class="more-photos" *ngIf="a.photos.length > 5">
        +{{ a.photos.length - 5 }}
      </div>
    </div>
  </div>

  <div class="content-container">
    <!-- Property Info Card -->
    <ion-card class="property-card">
      <ion-card-content>
        <div class="header-section">
          <h1>{{ a.title }}</h1>
          <div class="location" *ngIf="a.address?.city || a.address?.country">
            <ion-icon name="location-outline"></ion-icon>
            <span>{{ a.address?.city }}{{ a.address?.city && a.address?.country ? ', ' : '' }}{{ a.address?.country }}</span>
          </div>
        </div>

        <div class="price-section">
          <div class="price-tag">
            <span class="amount">{{ pricePerDay | number: '1.0-0' }}</span>
            <span class="currency">{{ a.currency || 'TND' }}</span>
            <span class="period">/ jour</span>
          </div>
        </div>

        <!-- Features -->
        <div class="features-grid">
          <div class="feature-item" *ngIf="a.bedrooms">
            <ion-icon name="bed-outline"></ion-icon>
            <div>
              <strong>{{ a.bedrooms }}</strong>
              <span>{{ a.bedrooms > 1 ? 'Chambres' : 'Chambre' }}</span>
            </div>
          </div>
          <div class="feature-item" *ngIf="a.bathrooms">
            <ion-icon name="water-outline"></ion-icon>
            <div>
              <strong>{{ a.bathrooms }}</strong>
              <span>{{ a.bathrooms > 1 ? 'Salles de bain' : 'Salle de bain' }}</span>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="description-section">
          <h3>Description</h3>
          <p>{{ a.description }}</p>
        </div>

        <!-- Address Details -->
        <div class="info-section" *ngIf="a.address">
          <h3>
            <ion-icon name="home-outline"></ion-icon>
            Adresse
          </h3>
          <p class="address-text">
            <span *ngIf="a.address?.street">{{ a.address.street }}<br></span>
            <span *ngIf="a.address?.city">{{ a.address.city }} </span>
            <span *ngIf="a.address?.postal_code">{{ a.address.postal_code }}<br></span>
            <span *ngIf="a.address?.country">{{ a.address.country }}</span>
          </p>
        </div>

        <!-- Contact Info -->
        <div class="info-section" *ngIf="a.contact">
          <h3>
            <ion-icon name="call-outline"></ion-icon>
            Contact
          </h3>
          <div class="contact-info">
            <div class="contact-item" *ngIf="a.contact.email">
              <ion-icon name="mail-outline"></ion-icon>
              <a [href]="'mailto:' + a.contact.email">{{ a.contact.email }}</a>
            </div>
            <div class="contact-item" *ngIf="a.contact.phone">
              <ion-icon name="call-outline"></ion-icon>
              <a [href]="'tel:' + a.contact.phone">{{ a.contact.phone }}</a>
            </div>
          </div>
        </div>

        <!-- Location Map Info -->
        <div class="info-section" *ngIf="a.location && (a.location.latitude || a.location.lat)">
          <h3>
            <ion-icon name="navigate-outline"></ion-icon>
            Localisation
          </h3>
          <p class="coordinates">
            Lat: {{ a.location.latitude || a.location.lat }}, 
            Long: {{ a.location.longitude || a.location.lng }}
          </p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Reservation Card -->
    <ion-card class="reservation-card" *ngIf="!a.isBooked">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="calendar-outline"></ion-icon>
          Réserver ce logement
        </ion-card-title>
        <ion-card-subtitle>Sélectionnez vos dates de séjour</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="date-inputs">
          <div class="date-input-group">
            <label>
              <ion-icon name="log-in-outline"></ion-icon>
              Date d'arrivée
            </label>
            <ion-datetime
              presentation="date"
              [(ngModel)]="startDate"
              (ionChange)="onDatesChanged()"
              placeholder="Choisir une date"
            ></ion-datetime>
          </div>

          <div class="date-input-group">
            <label>
              <ion-icon name="log-out-outline"></ion-icon>
              Date de départ
            </label>
            <ion-datetime
              presentation="date"
              [(ngModel)]="endDate"
              (ionChange)="onDatesChanged()"
              placeholder="Choisir une date"
              [min]="startDate"
            ></ion-datetime>
          </div>
        </div>

        <!-- Booking Summary -->
        <div class="booking-summary" *ngIf="startDate && endDate && estimatedDays > 0">
          <div class="summary-row">
            <span>Durée du séjour</span>
            <strong>{{ estimatedDays }} {{ estimatedDays > 1 ? 'jours' : 'jour' }}</strong>
          </div>
          <div class="summary-row">
            <span>{{ pricePerDay | number: '1.0-0' }} {{ a.currency || 'TND' }} × {{ estimatedDays }} {{ estimatedDays > 1 ? 'jours' : 'jour' }}</span>
            <strong>{{ pricePerDay * estimatedDays | number: '1.0-0' }} {{ a.currency || 'TND' }}</strong>
          </div>
          <div class="summary-divider"></div>
          <div class="summary-row total-row">
            <span>Total</span>
            <strong>{{ totalPrice | number: '1.0-0' }} {{ a.currency || 'TND' }}</strong>
          </div>
        </div>

        <ion-button 
          expand="block" 
          class="reservation-button"
          (click)="requestReservation()" 
          [disabled]="!startDate || !endDate || estimatedDays <= 0"
        >
          <ion-icon slot="start" name="paper-plane-outline"></ion-icon>
          Demander la réservation
        </ion-button>

        <p class="booking-note">
          <ion-icon name="information-circle-outline"></ion-icon>
          Vous ne serez pas débité maintenant. Le propriétaire doit d'abord approuver votre demande.
        </p>
      </ion-card-content>
    </ion-card>

    <!-- Already Booked Message -->
    <ion-card class="booked-card" *ngIf="a.isBooked">
      <ion-card-content>
        <div class="booked-message">
          <ion-icon name="lock-closed-outline"></ion-icon>
          <h3>Ce logement est déjà réservé</h3>
          <p>Cette propriété n'est actuellement pas disponible à la réservation.</p>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<ng-template #loadingTpl>
  <ion-content class="loading-content">
    <div class="loading-container">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Chargement des détails...</p>
    </div>
  </ion-content>
</ng-template>